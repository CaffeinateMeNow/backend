#
# Munin Cron stats collector
#

FROM dockermediacloud/mediacloud-base:latest

# Install packages
RUN \
    #
    # Install Munin stats collector
    apt-get -y --no-install-recommends install munin && \
    #
    # Install one extra dependency to fix hostname resolution
    # (https://github.com/munin-monitoring/munin/issues/1109#issuecomment-449397665)
    apt-get -y --no-install-recommends install libio-socket-ssl-perl && \
    #
    # Install patch for monkey-patching Munin
    apt-get -y --no-install-recommends install patch && \
    true

# Symlink logs to STDOUT
RUN \
    rm /var/log/munin/*.log && \
    ln -s /dev/stdout /var/log/munin/munin-cgi-graph.log && \
    ln -s /dev/stdout /var/log/munin/munin-cgi-html.log && \
    ln -s /dev/stdout /var/log/munin/munin-html.log && \
    ln -s /dev/stdout /var/log/munin/munin-limits.log && \
    ln -s /dev/stdout /var/log/munin/munin-update.log && \
    true

# Configure Munin
RUN \
    #
    # Don't generate graphs in Cron job as they'll be generated by CGI script
    sed -i -e "s/^#graph_strategy .*/graph_strategy cgi/" /etc/munin/munin.conf && \
    #
    # Remove localhost from configuration
    sed -i -e "s/^\[localhost.*//" /etc/munin/munin.conf && \
    sed -i -e "s/\s*address 127.*//" /etc/munin/munin.conf && \
    sed -i -e "s/\s*use_node_name 127.*//" /etc/munin/munin.conf && \
    true

# Replace misc. configuration with our own
RUN rm -rf /etc/munin/munin-conf.d/
COPY munin-conf.d/ /etc/munin/munin-conf.d/

# Monkey-patch Munin's source for it to accept hostnames with underscores
#
# We're sinning here as '_' is illegal in a hostname according to RFC but
# Docker seems to work with underscores so for now let's just continue on
# cheating. But then maybe Docker container names count as domain names of
# sorts and not hostnames? I don't know really.)
COPY patches/Config.pm.diff /var/tmp/
RUN patch -p0 < /var/tmp/Config.pm.diff

# Create directory for PID file
RUN \
    mkdir -p /var/run/munin/ && \
    chown munin:munin /var/run/munin && \
    true

# Copy wrapper script
COPY bin/munin-cron.sh /

# Reset cron jobs
RUN \
    echo "*/5 * * * * root /munin-cron.sh 1> /dev/stdout 2> /dev/stderr" > /etc/cron.d/munin && \
    true

# Volume for RRD data (shared with munin-httpd)
VOLUME /var/lib/munin/

# Volume for generated HTML (shared with munin-httpd)
VOLUME /var/cache/munin/www/

# Set "cron" as default command to run
CMD ["cron", "-f"]
